{% extends "base.html" %}
{% load markdown_deux_tags %}
{% load static %}
{% load humanize %}

{% block page_title %}Elections in {{ postcode }}{% endblock page_title %}
{% block og_title %}Elections in {{ postcode }}{% endblock og_title %}
{% block og_description %}{% regroup postelections by election.election_date as header_elections_by_date %}{% if postelections.count == 0 %}No upcoming elections{% else %}On {{ header_elections_by_date.0.grouper }}, registered voters in {{ postcode }} will be able to vote in {{ header_elections_by_date.0.list|length|apnumber }} election{{ header_elections_by_date.0.list|length|pluralize }}{% endif %}{% endblock og_description %}

{% block content %}

{% if postelections.count != 1 %}

<div class="card next_election">
  {% if postelections.count == 0 %}
    We don't know of any upcoming elections.
  {% else %}
    {% regroup postelections by election.election_date as header_elections_by_date %}
    <h2>Elections in your area</h2>

    {% for election_group in header_elections_by_date %}
        <h3>{{ election_group.grouper|date:"l j F Y" }}</h3>

        <p>
          You will have {{ election_group.list|length|apnumber }}
          ballot paper{{ election_group.list|length|pluralize }} to fill out.
        </p>

        <ul>
          {% for post in election_group.list %}
          <li><a href="#election_{{ post.election.slug }}">{{ post.election }}{% if post.post.label != post.election %}: {{ post.post.label }}
            {% endif %}

          </a></li>
          {% endfor %}
        </ul>
    {% endfor%}
  {% endif %}
</div>
{% endif %}

{% regroup postelections by election.election_date as elections_by_date %}
{% for election_group in elections_by_date %}
  {% for postelection in election_group.list %}
  <div id="election_{{ postelection.election.slug }}" class="card">
    <h2>{{ postelection.election.name }}</h2>
    <h3>{{ postelection.post.label }}</h3>

    {% if not postelection.contested %}
    <div class="panel callout radius" style="background-color:#ffff99">
        This election isn't contested. That means that there are the same number of candidates nominated
        as there are seats up for election, so they all get positions without an election taking place.
    </div>
    {% endif %}

    {% if postelection.people %}
      <h3>Candidates</h3>
      {% if postelection.election.uses_lists %}
      <p>You will vote for your preferred party rather than a candidate on this ballot paper</p>
      {% include "elections/includes/_people_list_with_lists.html" with people=postelection.people %}
      {% else %}
      {% include "elections/includes/_people_list.html" with people=postelection.people %}
      {% endif %}
    {% endif %}


    {% if postelection.election.description %}
    {{ postelection.election.description|markdown }}
    {% endif %}

    {% if postelection.election.voting_system %}
    <details>
      <summary>How you vote</summary>
      <h5>{{ postelection.election.voting_system }}</h5>
      {{ postelection.election.voting_system.description|markdown }}
      <p><a href="{{ postelection.election.voting_system.wikipedia_url }}">
          Read more on wikipedia</a></p>
    </details>
    {% endif %}

    {% if postelection.election.voter_age %}
    <details>
      <summary>Can you vote in this election?</summary>
      <h5>Age</h5>
      <p>You need to be over {{ postelection.election.voter_age }} on the
      {{ postelection.election.election_date|date:"jS" }}
      of {{ postelection.election.election_date|date:"F Y" }} in order to vote in this election</p>
      {% if postelection.election.voter_citizenship %}
        <h5>Citizenship</h5>
        {{ postelection.election.voter_citizenship|markdown }}
      {% endif %}
    </details>
    {% endif %}


  </div>
  {% endfor %}
{% endfor %}


{% if polling_station.polling_station_known or polling_station.custom_finder%}
{# Add this at the top of the page if it's known, or at the bottom if it's not #}
{% include "elections/includes/_polling_place.html" %}
{% endif %}

<div class="card">
  {% include "notifications/includes/election_notification_form.html" %}
</div>


<div class="card">
  <p>
    Calendar of elections in {{ postcode }}:
    <a href="webcal://whocanivotefor.co.uk{% url 'postcode_ical_view' postcode %}">iCal feed</a>
  </p>
</div>

{% include "feedback/feedback_form.html" %}

{% endblock content %}


{% block in_page_javascript %}
<script>
fallback.ready(['jQuery'], function() {
  /*! http://mths.be/details v0.1.0 by @mathias | includes http://mths.be/noselect v1.0.3 */
  ;(function(a,f){var e=f.fn,d,c=Object.prototype.toString.call(window.opera)=='[object Opera]',g=(function(l){var j=l.createElement('details'),i,h,k;if(!('open' in j)){return false}h=l.body||(function(){var m=l.documentElement;i=true;return m.insertBefore(l.createElement('body'),m.firstElementChild||m.firstChild)}());j.innerHTML='<summary>a</summary>b';j.style.display='block';h.appendChild(j);k=j.offsetHeight;j.open=true;k=k!=j.offsetHeight;h.removeChild(j);if(i){h.parentNode.removeChild(h)}return k}(a)),b=function(i,l,k,h){var j=i.prop('open'),m=j&&h||!j&&!h;if(m){i.removeClass('open').prop('open',false).triggerHandler('close.details');l.attr('aria-expanded',false);k.hide()}else{i.addClass('open').prop('open',true).triggerHandler('open.details');l.attr('aria-expanded',true);k.show()}};e.noSelect=function(){var h='none';return this.bind('selectstart dragstart mousedown',function(){return false}).css({MozUserSelect:h,msUserSelect:h,webkitUserSelect:h,userSelect:h})};if(g){d=e.details=function(){return this.each(function(){var i=f(this),h=f('summary',i).first();h.attr({role:'button','aria-expanded':i.prop('open')}).on('click',function(){var j=i.prop('open');h.attr('aria-expanded',!j);i.triggerHandler((j?'close':'open')+'.details')})})};d.support=g}else{d=e.details=function(){return this.each(function(){var h=f(this),j=f('summary',h).first(),i=h.children(':not(summary)'),k=h.contents(':not(summary)');if(!j.length){j=f('<summary>').text('Details').prependTo(h)}if(i.length!=k.length){k.filter(function(){return this.nodeType==3&&/[^ \t\n\f\r]/.test(this.data)}).wrap('<span>');i=h.children(':not(summary)')}h.prop('open',typeof h.attr('open')=='string');b(h,j,i);j.attr('role','button').noSelect().prop('tabIndex',0).on('click',function(){j.focus();b(h,j,i,true)}).keyup(function(l){if(32==l.keyCode||(13==l.keyCode&&!c)){l.preventDefault();j.click()}})})};d.support=g}}(document,jQuery));

    $('details').details();
});
</script>
{% endblock in_page_javascript %}
